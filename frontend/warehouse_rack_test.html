<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Warehouse 3D</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Three.js (æœ¬åœ°ç«¯ module) -->
  <script type="importmap">
  {
    "imports": {
      "three": "/frontend/components/build/three.module.js",
      "three/examples/jsm/controls/OrbitControls.js":
        "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js",
      "three/examples/jsm/loaders/FontLoader.js":
        "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/FontLoader.js",
      "three/examples/jsm/loaders/TextGeometry.js":
        "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/geometries/TextGeometry.js"
    }
  }
  </script>

  <style>
    html, body {
      margin:0;
      height:100%;
      overflow:hidden;
    }
    #viewport { background:#020617; }
  </style>
</head>

<body class="bg-gray-900 text-white">

<div class="flex h-screen w-screen overflow-hidden">

  <!-- Sidebar -->
  <div class="w-80 bg-gray-800 p-5 space-y-4 overflow-y-auto">

    <h1 class="text-2xl font-bold mb-3">Warehouse 3D</h1>

    <!-- ----------------------------- -->
    <!-- å¤šå€‰åº«åˆ‡æ›ï¼ˆB+C æ¨¡çµ„ï¼‰ -->
    <!-- ----------------------------- -->
    <div>
      <label class="block text-sm mb-1">Warehouse åˆ‡æ›</label>
      <select id="warehouseSelect"
              class="w-full bg-gray-700 p-2 rounded outline-none">
        <option value="WH1">WH1</option>
        <option value="WH2">WH2</option>
        <option value="WH3">WH3</option>
        <option value="WH5">WH5</option>
        <option value="WH6">WH6</option>
        <option value="WH7">WH7</option>
        <option value="WH8">WH8</option>
      </select>
    </div>

    <!-- Rack åƒæ•¸ -->
    <div>
      <label class="block text-sm mb-1">Row æ•¸</label>
      <input id="rowsInput" type="number" value="12" class="w-full bg-gray-700 p-2 rounded" />
    </div>

    <div>
      <label class="block text-sm mb-1">Bay æ•¸</label>
      <input id="baysInput" type="number" value="50" class="w-full bg-gray-700 p-2 rounded" />
    </div>

    <div>
      <label class="block text-sm mb-1">Level æ•¸</label>
      <input id="levelsInput" type="number" value="5" class="w-full bg-gray-700 p-2 rounded" />
    </div>

    <div>
      <label class="block text-sm mb-1">Aisleï¼ˆèµ°é“å¯¬ï¼Œå…¬å°ºï¼‰</label>
      <input id="aisleInput" type="number" value="3.5" step="0.1"
             class="w-full bg-gray-700 p-2 rounded" />
    </div>

    <!-- Buttons -->
    <button id="rebuild"
            class="w-full bg-blue-600 hover:bg-blue-500 p-2 rounded font-semibold">
      Rebuild 3D
    </button>

    <button id="random"
            class="w-full bg-indigo-600 hover:bg-indigo-500 p-2 rounded font-semibold">
      Random Fill (Demo)
    </button>

    <button id="syncExcel"
            class="w-full bg-green-600 hover:bg-green-500 p-2 rounded font-semibold">
      Sync Excelï¼ˆAPIï¼‰
    </button>

    <button id="exportExcel"
            class="w-full bg-yellow-400 hover:bg-yellow-300 text-black p-2 rounded font-semibold">
      Export Excel
    </button>

    <!-- æœå°‹å„²ä½ -->
    <div class="mt-4">
      <label class="block text-sm mb-1">æœå°‹å„²ä½ï¼ˆEx: F1904ï¼‰</label>
      <input id="searchSlot" type="text" class="w-full bg-gray-700 p-2 rounded"
             placeholder="ä¾‹å¦‚ F-19-04 æˆ– F1904" />
      <button id="searchBtn"
              class="w-full bg-orange-600 hover:bg-orange-500 p-2 rounded font-semibold mt-2">
        Search
      </button>
    </div>

    <p class="text-xs text-gray-400 mt-4 leading-relaxed">
      ğŸ“Œ APIï¼š /api/{WH}/excel<br>
      ğŸ“Œ WebSocketï¼š /ws/{WH}<br><br>
      â›” Expiry Effectsï¼š<br>
      Expired â†’ ç´…ç®±ï¼‹ç™½æ¡†ï¼‹åŠ‡çƒˆæ™ƒå‹•ï¼‹é–ƒçˆ<br>
      30 å¤©å…§ â†’ ç™½ç®±ï¼‹ç´…æ¡†ï¼‹è·³å‹•
    </p>

    <div id="importTime" class="text-xs text-gray-400">
      æœ€å¾ŒåŒ¯å…¥æ™‚é–“ï¼šå°šæœªåŒ¯å…¥
    </div>

    <div id="slotInfo"
         class="bg-gray-700 mt-3 p-3 rounded min-h-[120px] text-sm leading-relaxed">
      è«‹é»é¸å„²ä½æˆ–åŒ¯å…¥ Excelã€‚
    </div>
  </div>

  <!-- 3D Viewport -->
  <div id="viewport" class="flex-1"></div>

</div>

<script type="module">
/* ==========================================================
   Import Modules
========================================================== */
import * as THREE from "three";
import { OrbitControls } from "three/examples/jsm/controls/OrbitControls.js";

/* ==========================================================
   FastAPI + WebSocket (å¤šå€‰åº« WH1~WH8)
========================================================== */

// Python FastAPIï¼ˆExcel APIï¼‰
const API_BASE = "https://warehouse-3d-python-api.onrender.com";

// Node.js WebSocket Server
const WS_BASE = "wss://warehouse-3d-websocket.onrender.com";

// ç•¶å‰å€‰åº«
let currentWarehouse = "WH1";

/* ==========================================================
   DOM Elements
========================================================== */
const viewport = document.getElementById("viewport");
const slotInfoEl = document.getElementById("slotInfo");
const importTimeEl = document.getElementById("importTime");

const ui = {
  rows: document.getElementById("rowsInput"),
  bays: document.getElementById("baysInput"),
  levels: document.getElementById("levelsInput"),
  aisle: document.getElementById("aisleInput"),
  rebuildBtn: document.getElementById("rebuild"),
  randomBtn: document.getElementById("random"),
  syncExcelBtn: document.getElementById("syncExcel"),
  exportExcelBtn: document.getElementById("exportExcel"),
  searchSlot: document.getElementById("searchSlot"),
  searchBtn: document.getElementById("searchBtn"),
  warehouseSelect: document.getElementById("warehouseSelect")
};

/* ==========================================================
   Constants
========================================================== */
const ROW_LABELS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
const STORAGE_KEY_PARAMS = "warehouse3d_params_v1";
const STORAGE_KEY_SLOTS = "warehouse3d_slots_v1";

function rowIndexToLabel(i) {
  return ROW_LABELS[i] || i;
}
function rowLabelToIndex(v) {
  if (!v) return null;
  let s = String(v).trim().toUpperCase();
  let idx = ROW_LABELS.indexOf(s);
  if (idx >= 0) return idx;
  let n = parseInt(s);
  return Number.isFinite(n) ? n : null;
}
function pad2(n) {
  return String(n).padStart(2, "0");
}
function slotKey(r, b, l) {
  return `${r}_${b}_${l}`;
}

/* ==========================================================
   WebGL Renderer + Scene
========================================================== */
const renderer = new THREE.WebGLRenderer({ antialias: true });
const camera = new THREE.PerspectiveCamera(
  50,
  viewport.clientWidth / viewport.clientHeight,
  0.1,
  4000
);

renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.setSize(viewport.clientWidth, viewport.clientHeight);
viewport.appendChild(renderer.domElement);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x020617);

camera.position.set(30, 25, 40);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

/* Lights */
scene.add(new THREE.AmbientLight(0xffffff, 0.7));
const dir = new THREE.DirectionalLight(0xffffff, 0.8);
dir.position.set(-30, 40, 20);
scene.add(dir);

/* åœ°é¢ Grid */
const gridBase = new THREE.GridHelper(600, 60, 0x22c55e, 0x1e293b);
gridBase.position.y = 0;
scene.add(gridBase);

/* Highlight Grid */
const gridRoute = new THREE.GridHelper(200, 40, 0x0ea5e9, 0x0f172a);
gridRoute.position.y = 0.02;
gridRoute.material.transparent = true;
gridRoute.material.opacity = 0.3;
scene.add(gridRoute);

/* åŸé» Cube */
const originCube = new THREE.Mesh(
  new THREE.BoxGeometry(0.6, 0.6, 0.6),
  new THREE.MeshStandardMaterial({ color: 0xeab308 })
);
originCube.position.set(0, 0.3, 0);
scene.add(originCube);

/* ==========================================================
   Warehouse 3D Objects
========================================================== */
let warehouseGroup = new THREE.Group();
scene.add(warehouseGroup);

const raycaster = new THREE.Raycaster();
const clock = new THREE.Clock();
const clickTargets = [];
const bins = [];
const logicalSlots = new Map();

let highlightedBin = null;
let highlightEndTime = 0;

/* å°ºå¯¸åƒæ•¸ */
const BIN_W = 1.1;
const BIN_H = 1.4;
const BIN_D = 1.2;
const BAY_GAP_X = 0.2;
const ROW_EXTRA = 0.4;

const COLORS = {
  wireNormal: 0x4b5563,
  cargoNormal: 0xc49a6c,
  wireNear: 0xef4444,
  cargoNear: 0xffffff,
  wireExpired: 0xffffff,
  cargoExpired: 0xef4444,
  wireHighlight: 0x22c55e
};

/* ==========================================================
   Utility: Generate 3D Objects
========================================================== */
function makeWireBox(w, h, d) {
  const geo = new THREE.EdgesGeometry(new THREE.BoxGeometry(w, h, d));
  const mat = new THREE.LineBasicMaterial({
    color: COLORS.wireNormal,
    transparent: true,
    opacity: 0.45
  });
  return new THREE.LineSegments(geo, mat);
}
function makeHitBox(w, h, d) {
  const geo = new THREE.BoxGeometry(w, h, d);
  const mat = new THREE.MeshBasicMaterial({
    transparent: true,
    opacity: 0.0,
    depthWrite: false
  });
  return new THREE.Mesh(geo, mat);
}
function makeCargo(w, h, d) {
  const geo = new THREE.BoxGeometry(w * 0.94, h * 0.9, d * 0.94);
  const mat = new THREE.MeshStandardMaterial({
    color: COLORS.cargoNormal,
    roughness: 0.85,
    metalness: 0
  });
  const m = new THREE.Mesh(geo, mat);
  m.visible = false;
  return m;
}

/* ==========================================================
   Build Warehouse
========================================================== */
function clearWarehouse() {
  scene.remove(warehouseGroup);
  warehouseGroup = new THREE.Group();
  scene.add(warehouseGroup);
  clickTargets.length = 0;
  bins.length = 0;
}

function rebuild() {
  const rows = parseInt(ui.rows.value) || 1;
  const bays = parseInt(ui.bays.value) || 1;
  const levels = parseInt(ui.levels.value) || 1;
  const aisle = parseFloat(ui.aisle.value) || 1;

  clearWarehouse();

  const baySpacing = BIN_W + BAY_GAP_X;
  const rowSpacing = BIN_D + ROW_EXTRA + aisle;

  const totalW = bays * baySpacing - BAY_GAP_X;
  const totalD = rows * rowSpacing - aisle;

  const x0 = -totalW / 2 + BIN_W / 2;
  const z0 = -totalD / 2 + BIN_D / 2;

  for (let r = 0; r < rows; r++) {
    const z = z0 + r * rowSpacing;
    for (let b = 0; b < bays; b++) {
      const x = x0 + b * baySpacing;
      for (let lv = 0; lv < levels; lv++) {
        const y = 0.05 + lv * BIN_H + BIN_H / 2;

        const wire = makeWireBox(BIN_W, BIN_H, BIN_D);
        const hit = makeHitBox(BIN_W, BIN_H, BIN_D);
        const cargo = makeCargo(BIN_W, BIN_H, BIN_D);

        wire.position.set(x, y, z);
        hit.position.set(x, y, z);
        cargo.position.set(x, y, z);

        warehouseGroup.add(wire, hit, cargo);

        const rec = {
          row: r,
          bay: b,
          level: lv,
          line: wire,
          hit,
          cargo,
          occupied: false,
          meta: null,
          expStatus: "ok",
          baseX: x,
          baseY: y,
          baseZ: z
        };
        bins.push(rec);
        hit.userData.bin = rec;
        clickTargets.push(hit);
      }
    }
  }

  fitCameraToObject(warehouseGroup);
  applyLogicalSlotsToBins();

  slotInfoEl.textContent = "å·²é‡å»º 3D åœ–é¢";
}

/* ==========================================================
   Apply Data
========================================================== */
function setOccupied(bin, occ) {
  bin.occupied = occ;
  bin.cargo.visible = occ;
}

function applyLogicalSlotsToBins() {
  for (const bin of bins) {
    const slot = logicalSlots.get(slotKey(bin.row, bin.bay, bin.level));
    if (slot) {
      bin.meta = slot.meta || null;
      bin.expStatus = slot.expStatus || "ok";
      setOccupied(bin, slot.occupied);
    } else {
      setOccupied(bin, false);
      bin.meta = null;
      bin.expStatus = "ok";
    }
  }
}

/* ==========================================================
   Excel â†’ Fetch from FastAPI
========================================================== */
async function fetchExcelFromAPI() {
  try {
    const url = `${API_BASE}/api/${currentWarehouse}/excel`;
    console.log("ğŸ“„ Fetching Excel:", url);

    const resp = await fetch(url);
    if (!resp.ok) {
      alert(`âŒ ç„¡æ³•è®€å– ${currentWarehouse} Excelï¼ˆAPI å›å‚³éŒ¯èª¤ï¼‰`);
      return null;
    }
    return await resp.arrayBuffer();
  } catch (err) {
    console.error("fetchExcelFromAPI error:", err);
    alert("Python API éŒ¯èª¤æˆ–æœªå•Ÿå‹•");
    return null;
  }
}

function excelToDate(v) {
  if (!v) return null;
  if (typeof v === "number") {
    return new Date(Date.UTC(1899, 11, 30) + v * 86400000);
  }
  return new Date(v);
}

function classifyExpiry(exp) {
  if (!exp) return "ok";
  const today = new Date();
  const diff = (exp - today) / 86400000;
  if (diff < 0) return "expired";
  if (diff <= 30) return "near";
  return "ok";
}

async function syncFromExcelAPI() {
  const buf = await fetchExcelFromAPI();
  if (!buf) return;

  const wb = XLSX.read(buf, { type: "array" });
  const sheet = wb.Sheets[wb.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

  const header = rows[0] || [];
  const idxRow = header.indexOf("Row");
  const idxBay = header.indexOf("Bay");
  const idxLvl = header.indexOf("Level");
  const idxOcc = header.indexOf("Occupied");
  const idxPN = header.indexOf("PN");
  const idxQty = header.indexOf("æ•¸é‡");
  const idxBat = header.indexOf("Batch");
  const idxExp = header.indexOf("Expire Date");
  const idxMfg = header.indexOf("Manufacture Date");

  logicalSlots.clear();

  for (let i = 1; i < rows.length; i++) {
    const row = rows[i];
    if (!row) continue;

    const r = rowLabelToIndex(row[idxRow]);
    const b = parseInt(row[idxBay]) - 1;
    const lv = parseInt(row[idxLvl]) - 1;

    const occ = row[idxOcc] == 1;

    const expDate = excelToDate(row[idxExp]);
    const expStatus = classifyExpiry(expDate);

    const meta = {
      PN: row[idxPN] ?? "",
      æ•¸é‡: row[idxQty] ?? "",
      Batch: row[idxBat] ?? "",
      "Expire Date": row[idxExp] ?? "",
      "Manufacture Date": row[idxMfg] ?? ""
    };

    logicalSlots.set(slotKey(r, b, lv), {
      row: r,
      bay: b,
      level: lv,
      occupied: occ,
      meta,
      expStatus,
      expDateISO: expDate ? expDate.toISOString().slice(0, 10) : null
    });
  }

  applyLogicalSlotsToBins();

  importTimeEl.textContent =
    "æœ€å¾ŒåŒ¯å…¥æ™‚é–“ï¼š" + new Date().toLocaleString();
  slotInfoEl.textContent = `ğŸ“ å·²åŒæ­¥ ${currentWarehouse} Excel`;
}

/* ==========================================================
   WebSocket Handling
========================================================== */
let ws = null;

function connectWS() {
  const url = `${WS_BASE}/ws/${currentWarehouse}`;
  console.log("ğŸ”Œ Connecting WS:", url);

  ws = new WebSocket(url);

  ws.onopen = () => console.log(`ğŸŸ¢ WS Connected (${currentWarehouse})`);

  ws.onclose = () => {
    console.log("ğŸ”´ WS closed. Reconnect in 5 sec...");
    setTimeout(connectWS, 5000);
  };

  ws.onerror = (e) => console.error("âš  WS Error:", e);

  ws.onmessage = (msg) => {
    const data = JSON.parse(msg.data);
    if (data.type === "update") {
      logicalSlots.clear();
      for (const slot of data.slots) {
        logicalSlots.set(
          slotKey(slot.row, slot.bay, slot.level),
          slot
        );
      }
      applyLogicalSlotsToBins();
      slotInfoEl.textContent = `ğŸ“¡ å·²æ”¶åˆ° WS æ›´æ–° (${currentWarehouse})`;
    }
  };
}

/* First time connect */
connectWS();

/* Warehouse switching */
ui.warehouseSelect.addEventListener("change", async () => {
  currentWarehouse = ui.warehouseSelect.value;
  try {
    ws.close();
  } catch {}
  setTimeout(connectWS, 300);
  await syncFromExcelAPI();
});

/* ==========================================================
   Search Slot
========================================================== */
function parseSlotCode(code) {
  if (!code) return null;
  let s = code.toUpperCase().replace(/[^A-Z0-9]/g, "");
  let match =
    s.match(/^([A-Z]+)(\d{2})(\d{2})$/) ||
    s.match(/^([A-Z]+)(\d)(\d)$/);

  if (!match) return null;

  const rowLabel = match[1];
  const bay = parseInt(match[2]);
  const lv = parseInt(match[3]);

  return {
    r: rowLabelToIndex(rowLabel),
    b: bay - 1,
    lv: lv - 1
  };
}

ui.searchBtn.addEventListener("click", () => {
  const res = parseSlotCode(ui.searchSlot.value);
  if (!res) {
    alert("æ ¼å¼éŒ¯èª¤ï¼šè«‹è¼¸å…¥ F1904 æˆ– F-19-04");
    return;
  }

  const bin = bins.find(
    (x) => x.row === res.r && x.bay === res.b && x.level === res.lv
  );
  if (!bin) {
    alert("æ‰¾ä¸åˆ°å„²ä½ï¼ˆè¶…å‡ºç¯„åœï¼‰");
    return;
  }

  /* Focus camera */
  const pos = new THREE.Vector3();
  bin.hit.getWorldPosition(pos);

  camera.position.set(pos.x + 6, pos.y + 6, pos.z + 6);
  controls.target.copy(pos);
  controls.update();

  highlightedBin = bin;
  highlightEndTime = clock.getElapsedTime() + 8;
});

/* ==========================================================
   Animation Loop
========================================================== */
renderer.setAnimationLoop(() => {
  const t = clock.getElapsedTime();

  for (const bin of bins) {
    const line = bin.line.material;
    const cargo = bin.cargo.material;

    let wireColor = COLORS.wireNormal;
    let cargoColor = COLORS.cargoNormal;
    let opacity = 0.55;

    if (bin.occupied) {
      if (bin.expStatus === "near") {
        wireColor = COLORS.wireNear;
        cargoColor = COLORS.cargoNear;
        opacity = 0.9;
      } else if (bin.expStatus === "expired") {
        wireColor = COLORS.wireExpired;
        cargoColor = COLORS.cargoExpired;
        opacity = 0.9;
      }
    }

    if (bin === highlightedBin && t < highlightEndTime) {
      wireColor = COLORS.wireHighlight;
      opacity = 1.0;
    }

    line.color.setHex(wireColor);
    line.opacity = opacity;
    cargo.color.setHex(cargoColor);
  }

  controls.update();
  renderer.render(scene, camera);
});

/* ==========================================================
   Button Events
========================================================== */
ui.rebuildBtn.addEventListener("click", rebuild);
ui.randomBtn.addEventListener("click", () => {
  logicalSlots.clear();
  for (const bin of bins) {
    const occ = Math.random() < 0.3;
    bin.occupied = occ;
    bin.cargo.visible = occ;
  }
  slotInfoEl.textContent = "å·²éš¨æ©Ÿå¡«è²¨ï¼ˆDemoï¼‰";
});

ui.syncExcelBtn.addEventListener("click", syncFromExcelAPI);

/* EXPORT Excel */
ui.exportExcelBtn.addEventListener("click", () => {
  const sorted = [...bins].sort(
    (a, b) =>
      a.row - b.row || a.bay - b.bay || a.level - b.level
  );

  const data = [
    [
      "Row",
      "Bay",
      "Level",
      "Occupied",
      "PN",
      "æ•¸é‡",
      "Batch",
      "Expire Date",
      "Manufacture Date"
    ]
  ];

  for (const bin of sorted) {
    const meta = bin.meta || {};
    data.push([
      rowIndexToLabel(bin.row),
      pad2(bin.bay + 1),
      pad2(bin.level + 1),
      bin.occupied ? 1 : 0,
      meta["PN"] ?? "",
      meta["æ•¸é‡"] ?? "",
      meta["Batch"] ?? "",
      meta["Expire Date"] ?? "",
      meta["Manufacture Date"] ?? ""
    ]);
  }

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

  const blob = new Blob(
    [XLSX.write(wb, { bookType: "xlsx", type: "array" })],
    {
      type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    }
  );

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `rack_status_${currentWarehouse}.xlsx`;
  a.click();
  URL.revokeObjectURL(url);
});

window.addEventListener("resize", () => {
  renderer.setSize(viewport.clientWidth, viewport.clientHeight);
  camera.aspect =
    viewport.clientWidth / viewport.clientHeight;
  camera.updateProjectionMatrix();
});

rebuild();
</script>
</body>
</html>
